name: Triggered
on: 
  repository_dispatch:
    types: [ "build_successful" ]
  workflow_dispatch:    
    inputs:
      image_registry:
        description: "Source image registry"
        required: true
      image_tag:
        description: "Image version to be deployed" 
        required: true       

      
jobs:
  set-variables:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.variables.outputs.version }}

    steps:

    - name: Set variables
      id: set-variables
      env:
        REGISTRY: ${{ github.event.inputs.image_registry }}
        TAG: ${{ github.event.inputs.image_tag }}
      run: |-        
        [ -z "$REGISTRY" ] && REGISTRY=${{ github.event.client_payload.image_registry }}
        [ -z "$TAG" ] && TAG=${{ github.event.client_payload.image_tag }}
        echo $REGISTRY:$TAG
        echo "::set-output name=version::[\""$REGISTRY:$TAG"\"]"

  payload:
    needs: set-variables
    runs-on: ubuntu-latest

    steps:
      - run: echo ${{ needs.variables.outputs.version }}

  version:
    needs: set-variables
    runs-on: ubuntu-latest

    strategy:    
      matrix:
        version: ${{ fromJson(needs.variables.outputs.version) }}

    steps:
      - run: echo ${{ needs.set-variables.outputs.version }}